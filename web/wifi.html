<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,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">
		<title>ESP</title>
	</head>
	<body>
		<div id="app">
			<div id="wifi" class="slider">
				<h1>Wi-Fi</h1>
				<div id="wifi-status" class="slider closed">
					<div class="section_header">
						<h2 class="text">Connected to:</h2>
					</div>
					<div class="section_body">
						<div class="ape"><div class="ssid_text"></div></div>	
					</div>
				</div>
				
				<div id="settings" >
					<div class="section_header">
						<h2 class="text">Settings</h2>
						<h2 class="refresh">v</h2>
					</div>
					<div class="section_body slider ">

						<input class="inp-cbx" id="cbx" type="checkbox" style="display: none;"/>
<label class="cbx" for="cbx"><span>
    <svg width="12px" height="10px" viewbox="0 0 12 10">
      <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
    </svg></span><span>CodePenChallenge</span></label>
						
						
					</div>
				</div>
				
				<div id="wifi-list">
					<div class="section_header">
						<h2 class="text">Choose a network...</h2>
						<h2 class="refresh">‚ü≤</h2>
					</div>
					<div class="section_body">
						<ul>
						</ul>
					</div>
				</div>
				
				
				
				
				
			</div>
			<div id="connect" class="slider closed">
				<h1>Enter Password</h1>
				<div class="section_header">
					<h2 class="text">Password for <span></span></h2>
				</div>
				<div class="section_body">
					<input id="pwd" class="text_input" type="password" placeholder="Password" value="">
					<div class="buttons">
						<input class="cancel" type="button" value="Cancel"/>
						<input class="join" type="button" value="Join" />
					</div>
				</div>
			</div>
			<div id="connect-wait" class="slider closed">
				<h1>Please wait...</h1>
				<div class="section_header">
					<h2 class="text">Connecting to <span></span></h2>
				</div>
				<div class="section_body">
					<div id="loading" style="padding-top: 30px">
						<div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>
						<p>Please wait while the device connects to the AP.</p>
					</div>
					<div id="connect-success">
						<h3 class="gr">Success!</h3>
						<p>The Soft AP will be disabled when the last client has disconnected from the ESP.</p>
					</div>
					<div id="connect-fail">
						<h3 class="rd">Connection Failed</h3>
						<p></p>
					</div>
					<div class="buttons">
						<input class="ok ctr" type="button" value="OK" />
					</div>
				</div>
			</div>
			<div id="connect-details" class="slider closed">
				<h1></h1>
				<div class="section_header">
					<h2 class="text">Connection Details</h2>
				</div>
				<div class="section_body">
					<div class="ape">IP Address:<div id="ip" class="fr"></div></div>
					<div class="ape">Subnet Mask:<div id="netmask" class="fr"></div></div>
					<div class="ape">Default Gateway:<div id="gw" class="fr"></div></div>
					<div class="buttons">
						<input class="ok ctr" type="button" value="OK" />
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			var selectedSSID = "";
			
//			const refreshAPInterval = 13000; 
			const checkStatusInterval = 7000;
//			var refreshAPTimer;
			var checkStatusTimer;
			
			var counter = 0;
			var connectAttempt = false;
			
			checkStatusTimer = setInterval(checkStatus, checkStatusInterval);
//			refreshAPTimer = setInterval(refreshAP, refreshAPInterval);
			refreshAP();
			
			
			document.querySelector("#wifi-status .ape").addEventListener("click", (e) => { 
				document.querySelector("#wifi").classList.add("closed");
				document.querySelector("#connect-details").classList.remove("closed");					
			});
 
			document.querySelector("#wifi-list ul").addEventListener("click", (e) => { 			
				if(e.target && e.target.textContent != "") {
					//this bubbles up looking for the li parent, then queries for the ssid_text child underneath
					selectedSSID = e.target.closest(".ape").querySelector(".ssid_text").textContent;					
					document.querySelector("#connect h2 span").textContent = selectedSSID;
					document.querySelector("#wifi").classList.add("closed");
					document.querySelector("#connect").classList.remove("closed");
				}
			});			

			document.querySelectorAll('.cancel').forEach(item => {
				item.addEventListener('click', (e) => { 
					selectedSSID = "";					
					document.querySelector("#connect").classList.add("closed");
					document.querySelector("#wifi").classList.remove("closed");
				})
			});	

			document.querySelector('.join').addEventListener('click', (e) => { 
				performConnect(); 
			});				

			document.querySelectorAll('.ok').forEach(item => {
				item.addEventListener('click', (e) => { 
					document.querySelector("#connect-details").classList.add("closed");					
					document.querySelector("#connect-wait").classList.add("closed");
					document.querySelector("#wifi").classList.remove("closed");
				})
			});	

			document.querySelector('#wifi-list .section_header .refresh').addEventListener('click', (e) => { 
				refreshAP(); 
			});		
			
			function refreshAP(){
				fetch("/ap.json", {
					cache: 'no-store',
					headers: {
					  'Content-Type': 'application/json'
					},
				}).then((response) => {
					if (!response.ok) {
						throw Error(response.statusText);
					}
					return response.json();
				}).then((data) => {
					var ul = document.querySelector("#wifi ul");
					ul.innerHTML = "";
					
					data.forEach(function(e, idx, array) {
					    var li = document.createElement("li");
						li.classList.add("ape");
						
						var div = document.createElement("div");
						div.classList.add("ssid_text");
						div.textContent = e.ssid;
						li.appendChild(div);
						
						var div = document.createElement("div");
						div.classList.add("prgbar");
						var inner_div = document.createElement("div");
						inner_div.classList.add("bar");
						inner_div.style.width = Math.min((e.rssi-(-95))/((-30)-(-95))*100,100)+"%";
						div.appendChild(inner_div);
						li.appendChild(div);					
						
						var div = document.createElement("div");
						div.classList.add("pw");
						div.textContent = e.auth==0?'':'üîí';
						li.appendChild(div);
						
						ul.appendChild(li);
					});
				}).catch((error) =>  {
					console.log(error);
				});  				
			}

			function checkStatus(){
				fetch("/status.json", {
					cache: 'no-store',
					headers: {
					  'Content-Type': 'application/json'
					},
				}).then((response) =>  {
					if (!response.ok) {
						throw Error(response.statusText);
					}
					return response.json();
				}).then((data) => {
					document.querySelector("#wifi-status .ssid_text").textContent = data["ssid"];
					document.querySelector("#connect-details h1").textContent = data["ssid"];
					document.querySelector("#ip").textContent = data["ip"];
					document.querySelector("#netmask").textContent = data["netmask"];
					document.querySelector("#gw").textContent = data["gw"];

					if (data['if_status'] === true) {
						document.querySelector("#wifi-status").classList.remove("closed");
					} else {
						document.querySelector("#wifi-status").classList.add("closed");					
					}
					if (connectAttempt === true) {
						if (data["if_status"] === true) {
							document.querySelector("#connect-wait .ok").disabled = false;
							
							document.querySelector("#loading" ).style.display = "none";
							document.querySelector("#connect-success" ).style.display = "block";
							document.querySelector("#connect-fail" ).style.display = "none";
																		
							connectAttempt = false;
						} else {
							if (counter > 2) {
								document.querySelector("#connect-wait .ok").disabled = false;
								
								document.querySelector("#connect-fail p").textContent = "Please double-check wifi password if any and make sure the access point has good signal."
								
								document.querySelector("#loading" ).style.display = "none";
								document.querySelector("#connect-success" ).style.display = "none";
								document.querySelector("#connect-fail" ).style.display = "block";
								
								connectAttempt = false;
							} else {
								counter++;
							}
						}
					}
				}).catch((error) =>  {
					console.log(error);
				});  
			}

			function performConnect(){
//				clearInterval(refreshAPTimer);
				clearInterval(checkStatusTimer);
		
				document.querySelector("#loading" ).style.display = "block";
				document.querySelector("#connect-success" ).style.display = "none";
				document.querySelector("#connect-fail" ).style.display = "none";
				
				document.querySelector("#connect-wait .ok").disabled = true;
				
				document.querySelector("#connect-wait h2 span").textContent = selectedSSID;
				document.querySelector("#connect").classList.add("closed");
				document.querySelector("#connect-wait").classList.remove("closed");
										
				counter = 0;
				connectAttempt = true;
				
				fetch("/connect.json", {
					method: 'POST',
					cache: 'no-store',
					headers: {
					  'Content-Type': 'application/json'
					},
					body: JSON.stringify({ 
						'ssid': selectedSSID, 
						'password': document.querySelector("#pwd").value
					})
				}).then((response) =>  {
					if (!response.ok) {
						throw Error(response.statusText);
					}
					checkStatusTimer = setInterval(checkStatus, checkStatusInterval);
//					refreshAPTimer = setInterval(refreshAP, refreshAPInterval);	
				}).catch((error) =>  {
					console.log(error);
					
					// Failed to get a response - probably changing AP and IP has changed
					document.querySelector("#connect-wait .ok").disabled = false;
					
					document.querySelector("#connect-fail p").textContent = "No response. You have most likely connected to the ESP via the router assigned address, and not directly to the ESP's Soft AP IP. The IP you have connected to is no longer valid."

					document.querySelector("#loading" ).style.display = "none";
					document.querySelector("#connect-success" ).style.display = "none";
					document.querySelector("#connect-fail" ).style.display = "block";
					
					connectAttempt = false;
				});
			}
		</script>
		<style>
			body {
				background:#3498db;
				font-family:sans-serif;
				font-size:14px;
				color:#777;
			}

			#app {
				background:#fff;
				max-width:400px;
				margin:30px auto;
				padding:30px;
				border-radius:5px;
			}		

			@media screen and (max-width: 400px) {
				body {
					font-size:12px;
				}
				#app {
					margin:15px auto;
					padding:15px;
				}
			}			
			h1 {
				display: block;
				text-align: center;
				margin: 0;
				padding: 5px;
				font-size: 1.4em
			}
			h2 {
				text-align: center;
				text-transform: uppercase;
				margin: 10px;
				color: #fff;
				font-size: 1.0em
			}
			h2.text {
				width: 100%;
			}
			h2.refresh {
				margin-left: auto;
			}
			h2.refresh:hover {
				cursor: pointer;
			}
			h3 {
				margin: 0;
				text-align: center;
				padding: 20px 0px 20px 0px;
			}	
			.section_header {
				display: flex;
				background-color:#3498db;
				border-radius: 10px 10px 0 0;
				margin-top:10px;
			}
			.section_body {
				border: 2px solid #3498db;
				border-top: none;
				border-radius: 0 0 10px 10px;
			}			
			p {
				padding: 10px;
				text-align: center;
			}
			
			.gr {
				color: green;
			}
			.rd {
				color: red;
			}
			
			ul {
				margin: 0px;
				padding: 0px;
			}
			li {
				list-style-type: none;
				border-bottom: 1px solid #888
			}
			ul > li:last-child {
				border: none;
			}
			.ape {
				padding: 10px;
				height: 24px;
				display: flex;
				align-items: center;
			}
			.ape:hover {
				cursor: pointer;
			}

			
			.ssid_text {
				width: 100%;
				text-align: center;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.prgbar{
				background-color: #f1f1f1;
				border-radius: 10px;
				width: 40px;
				margin: 0 20px;
			}
			.bar{
				background-color: #3498db;
				border-radius: 10px;
				height: 10px;
			}
			.pw {
				width: 20px;
				text-align: right;
			}
			
	  		.fr {
				margin-left: auto;
			}
			
			.buttons {
				padding: 15px 30px;
				display: flex;
				justify-content: center;
			}
			.join {
				margin-left: auto;
			}
			input[type="button"] {
				width: 100px;
				padding: 5px;
				text-align: center;
				display: block;
				
				background:#3498db;
				-webkit-appearance: none;
				color:#fff;
				cursor:pointer;
				border:0;
			}
			
			.slider {
				overflow-y: hidden;
				max-height: 800px;             /* approximate max height to fit 10 APs */

				transition-property: all;
				transition-duration: 0.5s;
				transition-timing-function: cubic-bezier(0, 1, 0.5, 1);
			}
			.slider.closed {
				max-height: 0;
			}			
			
			input {
				font: 1.1em tahoma, arial, sans-serif;
			}
			input:focus,
			select:focus,
			textarea:focus,
			button:focus {
				outline: none;
			}
			.text_input {
				border: none;
				padding: 15px 30px;
				width: 100%;
				box-sizing: border-box;		// includes padding in width calcs
			}


.cbx {
  margin: auto;
  -webkit-user-select: none;
  user-select: none;
  cursor: pointer;
}
.cbx span {
  display: inline-block;
  vertical-align: middle;
  transform: translate3d(0, 0, 0);
}
.cbx span:first-child {
  position: relative;
  width: 18px;
  height: 18px;
  border-radius: 3px;
  transform: scale(1);
  vertical-align: middle;
  border: 1px solid #3498db;
  transition: all 0.2s ease;
}
.cbx span:first-child svg {
  position: absolute;
  top: 3px;
  left: 2px;
  fill: none;
  stroke: #FFFFFF;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 16px;
  stroke-dashoffset: 16px;
  transition: all 0.3s ease;
  transition-delay: 0.1s;
  transform: translate3d(0, 0, 0);
}
.cbx span:first-child:before {
  content: "";
  width: 100%;
  height: 100%;
  background: #3498db;
  display: block;
  transform: scale(0);
  opacity: 1;
  border-radius: 50%;
}
.cbx span:last-child {
  padding-left: 8px;
}
.cbx:hover span:first-child {
  border-color: #3498db;
}

.inp-cbx:checked + .cbx span:first-child {
  background: #3498db;
  border-color: #3498db;
  animation: wave 0.4s ease;
}
.inp-cbx:checked + .cbx span:first-child svg {
  stroke-dashoffset: 0;
}
.inp-cbx:checked + .cbx span:first-child:before {
  transform: scale(3.5);
  opacity: 0;
  transition: all 0.6s ease;
}

@keyframes wave {
  50% {
    transform: scale(0.9);
  }
}




			/* SpinKit is licensed under the MIT License. Copyright (c) 2015 Tobias Ahlin */

			.spinner {
				width: 40px;
				height: 40px;
				position: relative;
				margin: 0 auto;
			}
			.double-bounce1,
			.double-bounce2 {
				width: 100%;
				height: 100%;
				border-radius: 50%;
				background-color: #3498db;
				opacity: 0.6;
				position: absolute;
				top: 0;
				left: 0;
				-webkit-animation: sk-bounce 2.0s infinite ease-in-out;
				animation: sk-bounce 2.0s infinite ease-in-out;
			}
			.double-bounce2 {
				-webkit-animation-delay: -1.0s;
				animation-delay: -1.0s;
			}
			@-webkit-keyframes sk-bounce {
				0%, 100% {
					-webkit-transform: scale(0.0)
				}
				50% {
					-webkit-transform: scale(1.0)
				}
			}
			@keyframes sk-bounce {
				0%, 100% {
					transform: scale(0.0);
					-webkit-transform: scale(0.0);
				}
				50% {
					transform: scale(1.0);
					-webkit-transform: scale(1.0);
				}
			}
			/* end of SpinKit */
		</style>
    </body>
</html>